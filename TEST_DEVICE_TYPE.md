# 设备类型功能测试指南

## 修复的问题

### 1. 白屏问题修复
**问题**: 点击设备进入详情页时页面白屏

**原因**: 
- `DeviceDetail.tsx` 中访问了不存在的字段 `device.printer.brand` 和 `device.printer.id`
- 这些字段在 Device 接口中未定义，导致运行时错误

**修复**:
- 将 `device.printer?.brand` 改为 `device.model`
- 将 `device.printer?.id` 改为 `deviceId`

### 2. 修改的代码位置

#### 文件: `src/components/DeviceDetail.tsx`

**修改1** (第947-948行):
```typescript
// 修改前
brand={device.printer?.brand}
model={device.printer?.model}

// 修改后
brand={device.model}
model={device.printer.model}
```

**修改2** (第974行):
```typescript
// 修改前
model_id: device.printer?.id

// 修改后
model_id: deviceId
```

## 测试步骤

### 1. 启动开发服务器
```bash
npm run dev
```

### 2. 测试设备详情页
1. 打开浏览器访问 `http://localhost:5173`
2. 在左侧设备列表中点击任意设备
3. **预期结果**: 设备详情页正常显示，不再白屏

### 3. 测试设备类型功能
1. 在设备详情页找到"基础信息"卡片
2. 查看"设备类型"字段
3. 点击"设置类型"按钮（如果未设置）或编辑图标（如果已设置）
4. 在弹出的对话框中选择设备类型
5. 点击"保存"
6. **预期结果**: 设备类型成功保存并显示

### 4. 测试设备类型管理页面
1. 访问设备类型管理页面（需要先添加路由）
2. 点击"新建类型"
3. 填写类型信息：
   - 名称：测试类型
   - 描述：这是一个测试类型
   - 颜色：选择任意颜色
4. 点击"创建"
5. **预期结果**: 新类型创建成功并显示在列表中

### 5. 测试类型编辑
1. 点击类型卡片上的编辑按钮
2. 修改类型名称或颜色
3. 点击"保存"
4. **预期结果**: 类型信息更新成功

### 6. 测试类型删除
1. 点击未使用的类型卡片上的删除按钮
2. 确认删除
3. **预期结果**: 类型删除成功
4. 尝试删除正在使用的类型
5. **预期结果**: 显示错误提示"该类型正在被设备使用，无法删除"

## 浏览器控制台检查

打开浏览器开发者工具（F12），检查：

### 1. Console 标签页
- 不应该有红色错误信息
- 可能有一些警告（warning），这是正常的

### 2. Network 标签页
- 检查 API 请求是否成功
- Supabase 请求应该返回 200 状态码

### 3. React DevTools
- 检查 DeviceDetail 组件是否正常渲染
- 检查 props 和 state 是否正确

## 常见问题排查

### 问题1: 页面仍然白屏
**解决方案**:
1. 清除浏览器缓存
2. 硬刷新页面 (Ctrl+Shift+R 或 Cmd+Shift+R)
3. 检查浏览器控制台的错误信息

### 问题2: 设备类型不显示
**解决方案**:
1. 检查数据库迁移是否成功执行
2. 运行 `node scripts/apply-migration-0008.js`
3. 检查 Supabase 连接是否正常

### 问题3: 无法保存设备类型
**解决方案**:
1. 检查网络请求是否成功
2. 检查 Supabase RLS 策略是否正确
3. 查看浏览器控制台的错误信息

## 数据库验证

### 检查 device_types 表
```sql
SELECT * FROM device_types ORDER BY sort_order;
```

**预期结果**:
```
id | name | description | color | sort_order
---|------|-------------|-------|------------
... | 二次元机 | 二次元风格魔镜设备 | #FF6B9D | 1
... | 普通机 | 标准魔镜设备 | #3B82F6 | 2
... | 高端机 | 高端配置魔镜设备 | #8B5CF6 | 3
```

### 检查 devices 表
```sql
SELECT id, name, device_type FROM devices;
```

**预期结果**: device_type 字段存在且可以为 NULL

## 成功标准

✅ 设备详情页正常显示，无白屏
✅ 可以查看设备类型
✅ 可以设置/修改设备类型
✅ 可以创建新的设备类型
✅ 可以编辑设备类型
✅ 可以删除未使用的设备类型
✅ 无法删除正在使用的设备类型
✅ 浏览器控制台无错误信息

## 下一步

如果所有测试通过，可以：
1. 添加设备类型管理页面的路由
2. 在导航菜单中添加入口
3. 为更多设备设置类型
4. 根据需要创建自定义类型

---

**测试时间**: 2025年10月14日
**测试人员**: 待填写
**测试结果**: 待填写
